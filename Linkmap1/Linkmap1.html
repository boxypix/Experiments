<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Interactive Map with Fixed Elements</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; /* Игнорировать клики */
        }

        .icon {
            position: absolute;
            width: 51px;
            height: 51px;
            background-size: cover;
            transform: translate(-50%, -50%);
            z-index: 3;
        }

        .station {
            position: absolute;
            width: 124px;
            height: 124px;
            background-size: cover;
            transform: translate(-50%, -50%);
            z-index: 4;
        }

        .line {
            position: absolute;
            width: 2px;
            background-color: white;
            transform-origin: top left;
            z-index: 2;
        }

        .broken-line {
            background-color: #FF581C;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="overlay">
        <div id="station" class="station" style="background: url('./mats/Station.png') no-repeat center;"></div>
        <div id="spot1" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spot2" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spot3" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spot4" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spotBroken" class="icon" style="background: url('./mats/Spot2.png') no-repeat center;"></div>
        <div id="line1" class="line"></div>
        <div id="line2" class="line"></div>
        <div id="line3" class="line"></div>
        <div id="line4" class="line"></div>
        <div id="lineBroken" class="line broken-line"></div>
    </div>
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: './Map.json', // Стиль карты
            center: [30.0, 50.0], // Центр карты
            zoom: 12,
            pitch: 0,
            bearing: 0
        });

        const stationCoords = [30.0, 50.0];
        const spots = [
            { id: 'spot1', coords: [30.01, 50.005] },
            { id: 'spot2', coords: [29.99, 50.007] },
            { id: 'spot3', coords: [30.02, 50.0] },
            { id: 'spot4', coords: [29.98, 50.003] },
            { id: 'spotBroken', coords: [30.015, 50.002] }
        ];

        // Утилита для преобразования координат в пиксели
        function projectCoords(coords) {
            const point = map.project(coords);
            return { x: point.x, y: point.y };
        }

        function updatePositions() {
            // Обновляем позицию станции
            const stationPixels = projectCoords(stationCoords);
            const station = document.getElementById('station');
            station.style.left = `${stationPixels.x}px`;
            station.style.top = `${stationPixels.y}px`;

            // Обновляем позиции спотов и линий
            spots.forEach((spot, index) => {
                const spotElement = document.getElementById(spot.id);
                const lineElement = document.getElementById(`line${index + 1}`);
                const spotPixels = projectCoords(spot.coords);

                // Споты
                spotElement.style.left = `${spotPixels.x}px`;
                spotElement.style.top = `${spotPixels.y}px`;

                // Линии
                const dx = stationPixels.x - spotPixels.x;
                const dy = stationPixels.y - spotPixels.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * (180 / Math.PI);

                lineElement.style.left = `${spotPixels.x}px`;
                lineElement.style.top = `${spotPixels.y}px`;
                lineElement.style.width = `${length}px`;
                lineElement.style.transform = `rotate(${angle}deg)`;
            });

            // Обновляем линию для сломанного спота
            const brokenSpot = spots.find(spot => spot.id === 'spotBroken');
            const brokenLine = document.getElementById('lineBroken');
            const brokenPixels = projectCoords(brokenSpot.coords);

            const dxBroken = stationPixels.x - brokenPixels.x;
            const dyBroken = stationPixels.y - brokenPixels.y;
            const lengthBroken = Math.sqrt(dxBroken * dxBroken + dyBroken * dyBroken);
            const angleBroken = Math.atan2(dyBroken, dxBroken) * (180 / Math.PI);

            brokenLine.style.left = `${brokenPixels.x}px`;
            brokenLine.style.top = `${brokenPixels.y}px`;
            brokenLine.style.width = `${lengthBroken}px`;
            brokenLine.style.transform = `rotate(${angleBroken}deg)`;
        }

        // Слушатели событий карты
        map.on('move', updatePositions);
        map.on('load', updatePositions);
    </script>
</body>
</html>
