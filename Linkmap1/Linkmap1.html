<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Interactive Map with Fixed-Size Spots</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
        }

        .icon {
            position: absolute;
            width: 51px;
            height: 51px;
            background-size: cover;
            transform: translate(-50%, -50%);
            z-index: 3; /* Над линиями */
        }

        .station {
            position: absolute;
            width: 124px;
            height: 124px;
            background-size: cover;
            transform: translate(-50%, -50%);
            z-index: 4; /* Над спотами */
        }

        .line {
            position: absolute;
            width: 2px;
            background-color: white;
            transform-origin: top center;
            z-index: 2; /* Под спотами, но над областью */
        }

        .broken-line {
            background-color: #FF581C;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="overlay">
        <canvas id="areaCanvas" style="z-index: 1;"></canvas> <!-- Area под всеми элементами -->
        <div id="station" class="station" style="background: url('./mats/Station.png') no-repeat center;"></div>
        <div id="spot1" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spot2" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spot3" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spot4" class="icon" style="background: url('./mats/Spot1.png') no-repeat center;"></div>
        <div id="spotBroken" class="icon" style="background: url('./mats/Spot2.png') no-repeat center;"></div>
        <div id="line1" class="line"></div>
        <div id="line2" class="line"></div>
        <div id="line3" class="line"></div>
        <div id="line4" class="line"></div>
        <div id="lineBroken" class="line broken-line"></div>
    </div>
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: './Map.json', // Используем стиль как подложку
            center: [30.0, 50.0], // Центр карты
            zoom: 12,
            pitch: 0,
            bearing: 0
        });

        // Отключаем наклон и поворот карты
        map.dragRotate.disable();
        map.touchZoomRotate.disableRotation();

        const stationCoords = [30.0, 50.0];
        const areaCanvas = document.getElementById('areaCanvas');
        const spots = [
            { id: 'spot1', coords: [30.01, 50.005] },
            { id: 'spot2', coords: [29.99, 50.007] },
            { id: 'spot3', coords: [30.02, 50.0] },
            { id: 'spot4', coords: [29.98, 50.003] },
            { id: 'spotBroken', coords: [30.015, 50.002] }
        ];

        // Утилита: преобразует координаты в пиксели
        function projectCoordsToPixels(coords) {
            const point = map.project(coords);
            return { x: point.x, y: point.y };
        }

        // Обновление области
        function updateArea() {
            const context = areaCanvas.getContext('2d');
            const topLeft = map.project([29.99, 50.01]);
            const bottomRight = map.project([30.01, 49.99]);

            areaCanvas.width = window.innerWidth;
            areaCanvas.height = window.innerHeight;

            context.clearRect(0, 0, areaCanvas.width, areaCanvas.height);
            context.beginPath();
            context.arc(
                (topLeft.x + bottomRight.x) / 2,
                (topLeft.y + bottomRight.y) / 2,
                (bottomRight.x - topLeft.x) / 2,
                0,
                2 * Math.PI
            );
            context.fillStyle = 'rgba(0, 128, 255, 0.1)';
            context.fill();
        }

        // Обновление позиций спотов, линии и станции
        function updatePositions() {
            const stationPixels = projectCoordsToPixels(stationCoords);

            // Станция
            const station = document.getElementById('station');
            station.style.left = `${stationPixels.x}px`;
            station.style.top = `${stationPixels.y}px`;

            // Споты и линии
            spots.forEach((spot, index) => {
                const spotElement = document.getElementById(spot.id);
                const lineElement = document.getElementById(`line${index + 1}`);

                const spotPixels = projectCoordsToPixels(spot.coords);
                spotElement.style.left = `${spotPixels.x}px`;
                spotElement.style.top = `${spotPixels.y}px`;

                // Линии
                const dx = stationPixels.x - spotPixels.x;
                const dy = stationPixels.y - spotPixels.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * (180 / Math.PI);

                lineElement.style.left = `${spotPixels.x}px`;
                lineElement.style.top = `${spotPixels.y}px`;
                lineElement.style.width = `${length}px`;
                lineElement.style.transform = `rotate(${angle}deg)`;
            });

            // Линия для сломанного спота
            const brokenSpot = spots.find(spot => spot.id === 'spotBroken');
            const brokenLine = document.getElementById('lineBroken');
            const brokenPixels = projectCoordsToPixels(brokenSpot.coords);

            const dxBroken = stationPixels.x - brokenPixels.x;
            const dyBroken = stationPixels.y - brokenPixels.y;
            const lengthBroken = Math.sqrt(dxBroken * dxBroken + dyBroken * dyBroken);
            const angleBroken = Math.atan2(dyBroken, dxBroken) * (180 / Math.PI);

            brokenLine.style.left = `${brokenPixels.x}px`;
            brokenLine.style.top = `${brokenPixels.y}px`;
            brokenLine.style.width = `${lengthBroken}px`;
            brokenLine.style.transform = `rotate(${angleBroken}deg)`;
        }

        // Обновление элементов при движении карты
        map.on('move', () => {
            updateArea();
            updatePositions();
        });

        // Первоначальная отрисовка
        map.on('load', () => {
            updateArea();
            updatePositions();
        });

        // Обновление размеров области при изменении размеров окна
        window.addEventListener('resize', updateArea);
    </script>
</body>
</html>
