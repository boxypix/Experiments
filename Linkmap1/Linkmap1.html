<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OpenStreetMap with Circles and Distances</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .distance-label {
            position: absolute;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 9px;
            font-weight: bold;
            pointer-events: none;
            z-index: 11; /* Над линиями */
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const centerCoords = [27.615513, -82.736779]; // Центр станции
        const circleRadii = [500, 1000, 1500]; // Радиусы кругов в метрах
        const lineColor = '#567C91'; // Цвет линии кругов
        const lineOpacity = 0.4; // Прозрачность линии кругов

        // Создаем карту с OpenStreetMap
        const map = L.map('map', { zoomControl: true }).setView(centerCoords, 14);

        // Устанавливаем масштаб так, чтобы ширина карты была 1500 метров
        map.fitBounds([
            [centerCoords[0] - 0.0135, centerCoords[1] - 0.0135], // Приблизительно соответствует 1500 м
            [centerCoords[0] + 0.0135, centerCoords[1] + 0.0135]
        ]);

        // Добавляем слой OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Добавляем круги
        circleRadii.forEach(radius => {
            L.circle(centerCoords, {
                radius: radius,
                color: lineColor,
                weight: 1,
                opacity: lineOpacity,
                dashArray: '3, 3'
            }).addTo(map);
        });

        // Функция для генерации случайных точек в радиусе
        function getRandomPoints(center, count, radius) {
            const points = [];
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * 2 * Math.PI;
                const offset = Math.sqrt(Math.random()) * (radius / 1000); // Радиус в градусах
                const lat = center[0] + offset * Math.cos(angle) / 111; // 1° широты ≈ 111 км
                const lng = center[1] + offset * Math.sin(angle) / (111 * Math.cos(center[0] * Math.PI / 180));
                points.push([lat, lng]);
            }
            return points;
        }

        // Генерируем 5 случайных точек
        const spotsCoords = getRandomPoints(centerCoords, 5, circleRadii[2]);

        // Идентифицируем сломанный спот (последняя точка)
        const brokenSpot = spotsCoords[spotsCoords.length - 1];

        // Добавляем станцию
        const stationIcon = L.icon({
            iconUrl: './mats/Station.svg',
            iconSize: [124, 124],
            iconAnchor: [62, 62] // Центр иконки
        });
        L.marker(centerCoords, { icon: stationIcon }).addTo(map);

        // Добавляем споты, линии и расстояния
        spotsCoords.forEach((spot, index) => {
            const isBroken = spot === brokenSpot;

            // Иконка спота
            const spotIcon = L.icon({
                iconUrl: isBroken ? './mats/Spot2.svg' : './mats/Spot1.svg',
                iconSize: [51, 51],
                iconAnchor: [25, 25] // Центр иконки
            });

            // Маркер спота
            L.marker(spot, { icon: spotIcon }).addTo(map);

            // Линия от спота к станции
            const lineColor = isBroken ? '#FF581C' : '#FFFFFF';
            const polyline = L.polyline([spot, centerCoords], { color: lineColor, weight: 2 }).addTo(map);

            // Добавляем расстояние
            const distance = (map.distance(spot, centerCoords) / 1000).toFixed(1); // В километрах
            const midPoint = L.latLng(
                (spot[0] + centerCoords[0]) / 2,
                (spot[1] + centerCoords[1]) / 2
            );

            const label = document.createElement('div');
            label.className = 'distance-label';
            label.textContent = `${distance} км`;

            const mapPane = document.querySelector('.leaflet-map-pane');
            mapPane.appendChild(label);

            function updateLabelPosition() {
                const point = map.latLngToLayerPoint(midPoint);
                label.style.left = `${point.x}px`;
                label.style.top = `${point.y}px`;
            }

            map.on('move', updateLabelPosition);
            map.on('zoom', updateLabelPosition);
            updateLabelPosition();
        });
    </script>
</body>
</html>
