<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Анапа — прогноз + новости о мазуте</title>

  <!-- Leaflet (карта) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <style>
    :root{
      --bg:#0f1320;
      --card:#151a27;
      --text:#d7dcec;
      --muted:#9aa3bd;
      --line:#232a41;
      --accent:#6aa6ff;
      --ok:#62d26f;
      --warn:#ffb020;
      --bad:#ff5a6a;
      --radius:14px;
      --pad:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg, #0b1020 0%, var(--bg) 100%);
      color:var(--text);
    }
    header{
      padding:22px var(--pad) 8px;
      max-width:1100px;
      margin:0 auto;
    }
    h1{margin:0 0 6px; font-size:22px; font-weight:700}
    .sub{color:var(--muted); font-size:13px}
    .wrap{max-width:1100px; margin:0 auto; padding:12px var(--pad) 40px}
    .grid{display:grid; gap:14px}
    .card{
      background:rgba(21,26,39,.92);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    #map{height:340px; border-radius:12px; overflow:hidden}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.15);
      color:var(--muted);
      font-size:12px;
    }
    .pill b{color:var(--text); font-weight:700}
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px
    }
    input[type="text"]{
      width:min(680px,100%);
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      outline:none;
      background:rgba(0,0,0,.22);
      color:var(--text);
    }
    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(106,166,255,.12);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
    }
    button:hover{border-color:rgba(106,166,255,.5)}
    .hint{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}
    .status{margin-top:10px; color:var(--muted); font-size:12px}
    .status.ok{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .status.bad{color:var(--bad)}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:10px 12px;
      background:#11172a;
      border-bottom:1px solid var(--line);
      font-weight:700;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(35,42,65,.65);
      font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric:tabular-nums}

    .loadingText{
      font-size:24px;
      font-weight:700;
      animation:loadingPulse 1s ease-in-out infinite;
    }
    @keyframes loadingPulse{
      0%{opacity:1}
      50%{opacity:.5}
      100%{opacity:1}
    }

    .statsRow{display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; margin-top:12px}
    .statCard{
      min-width:170px;
      flex:1 1 170px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.14);
      padding:10px 12px;
    }
    .statLabel{font-size:12px; font-weight:400; color:var(--muted); line-height:1.2}
    .statValue{margin-top:6px; font-size:32px; font-weight:800; line-height:1}
    .statUnit{font-size:14px; font-weight:700; color:var(--muted); margin-left:6px}
    .news{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .news a{
      color:var(--text);
      text-decoration:none;
    }
    .news a:hover{color:var(--accent)}
    .newsItem{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.14);
    }
    .newsItem .t{font-weight:700; line-height:1.35}
    .newsItem .m{margin-top:6px; color:var(--muted); font-size:12px}
    footer{max-width:1100px; margin:0 auto; padding:0 var(--pad) 22px; color:var(--muted); font-size:12px}
  </style>
</head>

<body>
  <header>
    <h1>Анапа — осбтановка</h1>
    <div class="sub">Карта сверху, прогноз на 6 дней, новости RSS по запросу.</div>
  </header>

  <div class="wrap grid">
    <!-- MAP -->
    <section class="card">
      <div class="row">
        <span class="pill">Точка: <b id="placeName">Анапа</b></span>
        <span class="pill">Координаты: <b class="mono" id="coords">—</b></span>
        <span class="pill">Источник прогноза: <b>Open-Meteo</b></span>
      </div>
      <div class="statsRow" aria-label="Погода сейчас">
        <div class="statCard">
          <div class="statLabel">Температура воздуха</div>
          <div class="statValue"><span id="nowAirTemp" class="mono">—</span><span class="statUnit">°C</span></div>
        </div>
        <div class="statCard">
          <div class="statLabel">Ветер</div>
          <div class="statValue"><span id="nowWind" class="mono">—</span><span class="statUnit">м/с</span></div>
        </div>
        <div class="statCard">
          <div class="statLabel">Порывы</div>
          <div class="statValue"><span id="nowGust" class="mono">—</span><span class="statUnit">м/с</span></div>
        </div>
        <div class="statCard">
          <div class="statLabel">Температура воды</div>
          <div class="statValue"><span id="nowWater" class="mono">—</span><span class="statUnit">°C</span></div>
        </div>
      </div>
      <div id="map" style="margin-top:12px"></div>
      <div class="hint">
        Карта — Leaflet + OpenStreetMap. Можно заменить координаты и подпись в коде.
      </div>
    </section>

    <!-- FORECAST -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:800; font-size:15px">Прогноз на сегодня + 5 дней</div>
          <div class="hint">Ветер/порывы/температура воздуха + (если доступно) температура воды.</div>
        </div>
        <button id="btnRefresh">Обновить</button>
      </div>

      <div class="status" id="wxStatus">—</div>

      <div style="margin-top:10px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>День</th>
              <th>Воздух, °C (min–max)</th>
              <th>Ветер, м/с (max)</th>
              <th>Порывы, м/с (max)</th>
              <th>Вода, °C (ср.)</th>
            </tr>
          </thead>
          <tbody id="wxTbody">
            <tr><td colspan="5" class="mono loadingText" style="color:var(--muted)">Загрузка…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- RSS -->
    <section class="card">
      <div style="font-weight:800; font-size:15px">Новости (RSS)</div>
      <div class="controls">
        <input id="rssQuery" type="text" value="мазут Анапа Краснодар" />
        <button id="btnNews" style="display:none">Обновить новости</button>
      </div>
      <div class="hint">
        Важно: на GitHub Pages RSS часто блокируется браузером из-за CORS. Поэтому ниже используется бесплатный
        прокси <span class="mono">allorigins.win</span> (он просто отдаёт RSS как текст, чтобы браузер мог прочитать).
        Если он временно не работает — новости могут не загрузиться.
      </div>

      <div class="status" id="newsStatus">—</div>
      <div class="news" id="newsList"></div>
    </section>
  </div>

  <footer>
    Подсказка: чтобы уменьшить нагрузку на источники, можно добавить кеширование (например, через Cloudflare Worker).
  </footer>

  <script>
    // ====== НАСТРОЙКИ (Анапа) ======
    const PLACE = "Анапа";
    const LAT = 44.894;     // примерно центр Анапы
    const LON = 37.316;

    // Open-Meteo (погода) — daily на 6 дней
    const WX_URL =
      "https://api.open-meteo.com/v1/forecast" +
      `?latitude=${LAT}&longitude=${LON}` +
      "&timezone=Europe/Moscow" +
      "&forecast_days=6" +
      "&daily=temperature_2m_max,temperature_2m_min,windspeed_10m_max,windgusts_10m_max" +
      "&hourly=temperature_2m,windspeed_10m,windgusts_10m";

    // Open-Meteo (море) — sea surface temperature hourly, потом сведём в среднее по дням
    // Если у Open-Meteo Marine что-то поменяется, просто отключится вода (код это переживёт).
    const MARINE_URL =
      "https://marine-api.open-meteo.com/v1/marine" +
      `?latitude=${LAT}&longitude=${LON}` +
      "&timezone=Europe/Moscow" +
      "&forecast_days=6" +
      "&hourly=sea_surface_temperature";

    // Google News RSS по запросу (русский)
    const googleNewsRssUrl = (q) =>
      "https://news.google.com/rss/search" +
      `?q=${encodeURIComponent(q)}` +
      "&hl=ru&gl=RU&ceid=RU:ru";

    // Прокси для обхода CORS (для RSS)
    const allOriginsRaw = (url) =>
      "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

    // ====== УТИЛИТЫ ======
    const fmtDay = (isoDate) => {
      // isoDate: YYYY-MM-DD
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString("ru-RU", { weekday: "short", day: "2-digit", month: "2-digit" });
    };

    const mean = (arr) => {
      if (!arr || arr.length === 0) return null;
      let s = 0;
      for (const x of arr) s += x;
      return s / arr.length;
    };

    function nearestTimeIndex(times, nowMs) {
      // times: array of ISO strings (e.g., 2026-01-08T12:00)
      if (!times || times.length === 0) return -1;
      let bestI = 0;
      let bestD = Infinity;
      for (let i = 0; i < times.length; i++) {
        const ms = Date.parse(times[i]);
        if (!Number.isFinite(ms)) continue;
        const d = Math.abs(ms - nowMs);
        if (d < bestD) {
          bestD = d;
          bestI = i;
        }
      }
      return bestI;
    }

    function setNowValue(id, v, digits = 0) {
      const el = document.getElementById(id);
      if (!el) return;
      if (v === null || v === undefined || Number.isNaN(v)) {
        el.textContent = "—";
        return;
      }
      el.textContent = Number(v).toFixed(digits);
    }

    function renderNowStats(wxJson, marineJsonOrNull) {
      const nowMs = Date.now();

      // air + wind + gust from Open-Meteo hourly
      const h = wxJson?.hourly;
      if (h?.time?.length) {
        const i = nearestTimeIndex(h.time, nowMs);
        setNowValue("nowAirTemp", h.temperature_2m?.[i], 0);
        setNowValue("nowWind", h.windspeed_10m?.[i], 1);
        setNowValue("nowGust", h.windgusts_10m?.[i], 1);
      } else {
        setNowValue("nowAirTemp", null);
        setNowValue("nowWind", null);
        setNowValue("nowGust", null);
      }

      // water from Marine hourly (if available)
      const mh = marineJsonOrNull?.hourly;
      if (mh?.time?.length) {
        const j = nearestTimeIndex(mh.time, nowMs);
        setNowValue("nowWater", mh.sea_surface_temperature?.[j], 1);
      } else {
        setNowValue("nowWater", null);
      }
    }

    function setStatus(el, text, kind = "") {
      el.className = "status" + (kind ? " " + kind : "");
      el.textContent = text;
    }

    // ====== КАРТА ======
    function initMap() {
      document.getElementById("placeName").textContent = PLACE;
      document.getElementById("coords").textContent = `${LAT.toFixed(3)}, ${LON.toFixed(3)}`;

      const map = L.map("map", { zoomControl: true }).setView([LAT, LON], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      const marker = L.marker([LAT, LON]).addTo(map);
      marker.bindPopup(`<b>${PLACE}</b><br/>${LAT.toFixed(3)}, ${LON.toFixed(3)}`).openPopup();
    }

    // ====== ПОГОДА ======
    async function fetchJson(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    function dailyWaterAveragesFromHourly(marineJson) {
      // Возвращаем Map(date -> avgTemp)
      const map = new Map();
      const hourly = marineJson?.hourly;
      if (!hourly || !hourly.time || !hourly.sea_surface_temperature) return map;

      const times = hourly.time;
      const temps = hourly.sea_surface_temperature;

      const bucket = new Map(); // date -> []
      for (let i = 0; i < times.length; i++) {
        const t = times[i];
        const v = temps[i];
        if (v === null || v === undefined) continue;
        const date = t.slice(0, 10); // YYYY-MM-DD
        if (!bucket.has(date)) bucket.set(date, []);
        bucket.get(date).push(v);
      }

      for (const [date, arr] of bucket.entries()) {
        map.set(date, mean(arr));
      }
      return map;
    }

    function renderForecast(wxJson, waterMap) {
      const tb = document.getElementById("wxTbody");
      const d = wxJson?.daily;
      if (!d) {
        tb.innerHTML = `<tr><td colspan="5" style="color:var(--bad)">Нет данных daily</td></tr>`;
        return;
      }

      const dates = d.time || [];
      const tmax = d.temperature_2m_max || [];
      const tmin = d.temperature_2m_min || [];
      const wmax = d.windspeed_10m_max || [];
      const gmax = d.windgusts_10m_max || [];

      const rows = [];
      for (let i = 0; i < Math.min(6, dates.length); i++) {
        const date = dates[i];
        const water = waterMap?.get(date);
        rows.push(`
          <tr>
            <td class="mono">${fmtDay(date)}</td>
            <td class="mono">${Number(tmin[i]).toFixed(0)} – ${Number(tmax[i]).toFixed(0)}</td>
            <td class="mono">${Number(wmax[i]).toFixed(1)}</td>
            <td class="mono">${Number(gmax[i]).toFixed(1)}</td>
            <td class="mono">${water == null ? "—" : water.toFixed(1)}</td>
          </tr>
        `);
      }
      tb.innerHTML = rows.join("");
    }

    async function loadForecast() {
      const st = document.getElementById("wxStatus");
      setStatus(st, "Загружаю прогноз…");

      try {
        const [wx, marine] = await Promise.allSettled([
          fetchJson(WX_URL),
          fetchJson(MARINE_URL),
        ]);

        if (wx.status !== "fulfilled") throw wx.reason;

        // Рендер «сейчас» (почасовые значения, ближайшие ко времени устройства)
        const marineJsonForNow = marine.status === "fulfilled" ? marine.value : null;
        renderNowStats(wx.value, marineJsonForNow);

        let waterMap = new Map();
        if (marine.status === "fulfilled") {
          waterMap = dailyWaterAveragesFromHourly(marine.value);
          setStatus(st, "Прогноз обновлён. Температура воды: есть данные.", "ok");
        } else {
          setStatus(st, "Прогноз обновлён. Температура воды: источник недоступен — показываю без воды.", "warn");
        }

        renderForecast(wx.value, waterMap);
      } catch (e) {
        renderNowStats({}, null);
        setStatus(st, "Ошибка загрузки прогноза: " + (e?.message || e), "bad");
        document.getElementById("wxTbody").innerHTML =
          `<tr><td colspan="5" style="color:var(--bad)">Не удалось загрузить прогноз</td></tr>`;
      }
    }

    // ====== RSS НОВОСТИ ======
    function parseRss(xmlText) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "text/xml");
      const items = [...xml.querySelectorAll("item")].slice(0, 12);

      return items.map((it) => ({
        title: it.querySelector("title")?.textContent?.trim() || "(без заголовка)",
        link: it.querySelector("link")?.textContent?.trim() || "#",
        pubDate: it.querySelector("pubDate")?.textContent?.trim() || "",
        source: it.querySelector("source")?.textContent?.trim() || "",
      }));
    }

    function renderNews(items) {
      const list = document.getElementById("newsList");
      if (!items || items.length === 0) {
        list.innerHTML = `<div style="color:var(--muted)">Ничего не найдено.</div>`;
        return;
      }
      list.innerHTML = items
        .map((n) => `
          <div class="newsItem">
            <div class="t"><a href="${n.link}" target="_blank" rel="noopener noreferrer">${n.title}</a></div>
            <div class="m">${n.source ? n.source + " · " : ""}${n.pubDate}</div>
          </div>
        `)
        .join("");
    }

    async function loadNews() {
      const st = document.getElementById("newsStatus");
      const q = document.getElementById("rssQuery").value.trim() || "Анапа";
      const rssUrl = googleNewsRssUrl(q);

      setStatus(st, "Загружаю RSS…");

      try {
        // Через allorigins (обход CORS)
        const r = await fetch(allOriginsRaw(rssUrl), { cache: "no-store" });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const xmlText = await r.text();
        const items = parseRss(xmlText);

        setStatus(st, `Готово. Показано ${items.length} новостей по запросу: "${q}".`, "ok");
        renderNews(items);
      } catch (e) {
        setStatus(st, "Не удалось загрузить RSS (часто это CORS/прокси). " + (e?.message || e), "bad");
        document.getElementById("newsList").innerHTML = "";
      }
    }

    // ====== ИНИТ ======
    window.addEventListener("DOMContentLoaded", () => {
      // Leaflet грузится defer-скриптом, подождём микро-тик
      const waitLeaflet = setInterval(() => {
        if (window.L && document.getElementById("map")) {
          clearInterval(waitLeaflet);
          initMap();
        }
      }, 30);

      document.getElementById("btnRefresh").addEventListener("click", loadForecast);
      const btnNews = document.getElementById("btnNews");
      btnNews.addEventListener("click", loadNews);

      // Автозагрузка
      loadForecast();
      loadNews(); // новости запрашиваем сразу при старте

      // Кнопку "Обновить новости" показываем только через 5 минут
      setTimeout(() => {
        btnNews.style.display = "inline-flex";
      }, 5 * 60 * 1000);
    });
  </script>
</body>
</html>